
<html>
<head>
    <meta charset="UTF-8">
    <style type="text/css">
        #container {
            margin-left: 10%;
            max-width: 90%;
            height: 100%;
            margin: auto;
        }
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 10%;
            background-color: #f1f1f1;
            height: 100%; /* Full height */
            position: fixed; /* Make it stick, even on scroll */
            overflow: auto; /* Enable scrolling if the sidenav has too much content */
        }
        li {
            display: block;
            color: #000;
            padding: 8px 16px;
            text-decoration: none;
        }
        li:hover{
            background: #8699a4;
        }
    </style>
</head>
<body>
<button onclick="gridify()">Gridify</button>
<ul id="turnsbuttonbar"></ul>
<div id="container"></div>
<script src="sigma.min.js"></script>
<script src="sigma.plugins.animate.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    var text = `20
##start
start 0 1
##end
end 1 0
0 0 0
1 1 1
2 2 2
3 3 3
4 4 4
5 5 5
6 6 6
7 7 7
8 8 8
9 9 9
10 10 10
11 11 11
12 12 12
13 13 13
14 14 14
15 15 15
16 16 16
17 17 17
18 18 18
19 19 19
20 20 20
21 21 21
22 22 22
23 23 23
24 24 24
25 25 25
26 26 26
27 27 27
28 28 28
29 29 29
30 30 30
31 31 31
32 32 32
33 33 33
34 34 34
35 35 35
36 36 36
37 37 37
38 38 38
39 39 39
40 40 40
41 41 41
42 42 42
43 43 43
44 44 44
45 45 45
46 46 46
47 47 47
48 48 48
49 49 49
50 50 50
51 51 51
52 52 52
53 53 53
54 54 54
55 55 55
56 56 56
57 57 57
58 58 58
59 59 59
60 60 60
61 61 61
62 62 62
63 63 63
64 64 64
65 65 65
66 66 66
67 67 67
68 68 68
69 69 69
70 70 70
71 71 71
72 72 72
73 73 73
74 74 74
75 75 75
76 76 76
77 77 77
78 78 78
79 79 79
0-38
0-36
1-20
2-0
3-66
4-35
4-71
5-31
6-13
7-50
8-24
9-45
9-1
9-12
10-59
11-35
11-36
12-17
13-28
13-54
13-27
14-71
14-51
14-8
15-12
15-34
15-73
16-74
17-42
17-26
17-59
18-3
18-37
18-53
18-65
18-20
19-25
20-10
20-63
21-55
21-37
22-55
23-66
24-63
24-59
24-32
24-53
24-73
25-24
25-10
26-44
26-60
26-72
27-71
27-51
27-61
27-43
27-64
28-66
29-5
29-9
30-29
31-77
31-21
31-28
31-73
31-30
31-9
31-72
32-17
33-28
34-27
35-55
36-43
36-6
36-11
36-4
37-12
38-44
38-63
38-64
38-6
38-60
38-56
38-45
39-54
39-41
39-49
39-59
39-42
40-20
41-34
41-46
42-31
43-69
43-0
43-32
43-34
43-6
43-21
43-51
43-74
43-56
44-22
45-67
46-19
46-48
46-25
46-37
47-61
47-66
47-79
47-39
48-64
48-76
49-38
50-6
51-14
51-3
51-58
51-10
52-15
53-68
54-55
54-42
54-61
55-6
56-0
57-37
57-7
57-77
58-18
59-33
59-23
60-45
61-43
61-50
62-19
62-23
63-70
64-73
65-75
65-18
65-29
66-19
66-48
67-77
68-31
68-8
69-39
70-31
71-22
71-65
72-7
72-64
72-14
72-50
72-46
72-33
73-63
73-38
74-28
75-72
75-3
75-78
76-55
77-28
77-15
77-33
78-65
78-79
79-5
start-53
start-61
start-62
end-32
end-63
end-33

L18-62 L19-53 L20-61 
L15-62 L16-53 L17-61 L18-23 L19-24 L20-43 
L12-62 L13-53 L14-61 L15-23 L16-24 L17-43 L18-59 L19-63 L20-32 
L9-62 L10-53 L11-61 L12-23 L13-24 L14-43 L15-59 L16-63 L17-32 L18-33 L19-end L20-end 
L6-62 L7-53 L8-61 L9-23 L10-24 L11-43 L12-59 L13-63 L14-32 L15-33 L16-end L17-end L18-end 
L3-62 L4-53 L5-61 L6-23 L7-24 L8-43 L9-59 L10-63 L11-32 L12-33 L13-end L14-end L15-end 
L1-53 L2-61 L3-23 L4-24 L5-43 L6-59 L7-63 L8-32 L9-33 L10-end L11-end L12-end 
L1-24 L2-43 L3-59 L4-63 L5-32 L6-33 L7-end L8-end L9-end 
L1-63 L2-32 L3-33 L4-end L5-end L6-end 
L1-end L2-end L3-end 
`;
    text = text.replace(/\s\{2,}/g, ' ');
    text = text.split('\n');
    var s = new sigma('container');
    var graphcopy = new sigma.classes.graph();
    var lemins = text.shift();
    var turnsarray = [];
    var mode = 0;
    var repart = [-50, 50, 15];
    var turns = 0;
    var startid = {};
    var endid = {};

    function generateLeminColor(seed) {
        return (
            "#"+ Math.floor((Math.abs(Math.sin(seed) * 16777215)) % 
            16777215).toString(16)
        );
    }

    function parse_room_init(line, special) {
        var room = line.split(" ");
        var size = 3;
        var color = '#f00';

        if (special == "start") {
            size = lemins;
            startid = room[0];
        }
        if (special == "start" || special == "end") {
            color = '#0f9';
        }
        if (special == "end")
            endid = room[0];
        s.graph.addNode({
            id: room[0],
            label: room[0],
            x: room[1],
            y: room[2],
            basic_x: room[1],
            basic_y: room[2],
            grid_x: room[1] % 50,
            grid_y: Math.floor(room[2] / 50),
            size: size,
            color: color
        });
        graphcopy.addNode(
            {
                id: room[0],
                label: room[0],
                x: room[1],
                y: room[2],
                basic_x: room[1],
                basic_y: room[2],
                grid_x: room[1] % 50,
                grid_y: Math.floor(room[2] / 50),
                size: size,
                color: color
            }
        )
    }

    function parse_link(line) {
        var link = line.split("-");
        var color = generateLeminColor(Math.random());
        console.log("Add link: " + line);
        s.graph.addEdge({
            id: line,
            source: link[0],
            target: link[1],
            color: color,
            type: 'curve',
            size: 0.1
        });
        graphcopy.addEdge(
            {
                id: line,
                source: link[0],
                target: link[1],
                color: color,
                type: 'curve',
                size: 0.1
            }
        )
    }

    function applyTurnToGraph(line) {
        var leminsPosition = line.split(" ");

        leminsPosition.forEach(function(element, index, array) {
            var linfo = element.split("-");

            s.graph.nodes(linfo[1]).label += " " + linfo[0];
            s.graph.nodes(linfo[1]).color = generateLeminColor(linfo[0].substr(1));
        });
    }

    function setEndSize(elementvalue) {
        for (var i = 0; i < elementvalue; i++) {
            var leminsPosition = turnsarray[i].split(" ");

            leminsPosition.forEach(function(elem, index, array) {
               var linfo = elem.split("-");

               if (linfo[1] == endid)
                   s.graph.nodes(linfo[1]).size += 1;
               else
                   s.graph.nodes(linfo[1]).size = s.graph.nodes().length
            });
        }
    }

    function showTurn(element) {
        applyTurnToGraph(turnsarray[element.value]);
        setEndSize(element.value);
        s.refresh();
        s.graph.clear();
        s.graph.read({nodes: graphcopy.nodes(), edges: graphcopy.edges()});
    }

    function getLinksFromTurn(turn, turnindex) {
        var links = [];
        var leminPos = turn.split(" ");
        leminPos.forEach(function(lemin, index, array) {
            var infos = lemin.split("-");
            if (turnindex == 0)
                links.push(startid + "-" + infos[1]);
            else {
                var previousLeminPos = turnsarray[turnindex - 1].split(" ");
                for (var i = 0; i < previousLeminPos.length; i++) {
                    var pinfos = previousLeminPos[i].split("-");
                    
                    if (pinfos[0] == infos[0]) {
                        links.push(pinfos[1] + "-" + infos[1]);
                        break;
                    }
                }
            }
        });
        return (links);
    }

    function initGraph() {
        text.forEach(function (line, index, array) {
            line = line.replace(/(^\s+|\s+$)/g, '');
            if (line[0] == 'L'){
                $('#turnsbuttonbar').append(
                    "<li class='turnsbutton' type='button' value='" +
                    turnsarray.length +
                    "' onclick='showTurn(this)'>" + turnsarray.length + "</li>"
                );
                turnsarray.push(line);
            }
            else if  (mode == 3) {
                mode = 0;
            }
            else if (line == "##start") {
                parse_room_init(array[index + 1], "start");
                mode = 3;
            }
            else if (line == "##end") {
                parse_room_init(array[index + 1], "end");
                mode = 3;
            }
            else if (line[0] == '#') {

            }
            else if (mode == 0 && line.indexOf("-") > -1)
                mode = 1;
            else if (mode == 0)
                parse_room_init(line, "none");
            else if (mode == 1 && line.indexOf("-") > -1) {
                //parse_link(line);
            }
        });

        turnsarray.forEach(function(elem, index, array) {
            links = getLinksFromTurn(elem, index);
            links.forEach(function(elem, index, array) {
                try {
                    parse_link(elem);
                }
                catch(err) {
                    console.log(err);
                }
            });
        });
        s.graph.nodes(endid).size = s.graph.nodes().length;
        s.graph.nodes(startid).size = s.graph.nodes().length;
        graphcopy.nodes(endid).size = graphcopy.nodes().length;
        graphcopy.nodes(startid).size = graphcopy.nodes().length;
    }

    var step = 0;
    function gridify() {
        var prefix = ['grid_', 'basic_'][step = +!step];
        sigma.plugins.animate(
         s,
         {
           x: prefix + 'x',
           y: prefix + 'y',
         }
        );
        graphcopy.nodes().forEach(function(elem, ind, arr) {
            if (prefix == 'grid_')
            {
                elem.x = elem.grid_x;
                elem.y = elem.grid_y;
            }
            else {
                elem.x = elem.basic_x;
                elem.y = elem.basic_y;
            }
        });
    }

    initGraph();
    s.settings.animationTime =  1000;
    s.refresh();
</script>
</body>
</html>
