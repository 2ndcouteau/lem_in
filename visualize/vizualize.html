<html>
<head>
    <meta charset="UTF-8">
    <style type="text/css">
        #container {
            max-width: 1000px;
            height: 500px;
            margin: auto;
        }
        /*#turnsbuttonbar {*/
            /*max-width: 100%;*/
            /*height: 30px;*/
            /*text-align: center;*/
            /*margin: auto;*/
            /*background-color: #2b81af;*/
        /*}*/
        /*.turnsbutton {*/
            /*height: 25px;*/
            /*width: 25px;*/
            /*background-color: #3c510c;*/
        /*}*/
    </style>
</head>
<body>
<ul id="turnsbuttonbar"></ul>
<div id="container"></div>
<script src="sigma.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    var text = `4
##start
start 1 1
##end
end 40 20
dead0 20 10
dead1 15 15
mid0 50 10
mid1 60 20
mid2 70 30
start-dead0
start-mid0
mid0-dead0
start-mid1
mid1-mid2
mid2-end

L4-mid1
L3-mid1 L4-mid2
L2-mid1 L3-mid2 L4-end
L1-mid1 L2-mid2 L3-end
L1-mid2 L2-end
L1-end`.split("\n");
    var s = new sigma('container');
    var graphcopy = new sigma.classes.graph();
    var lemins = text.shift();
    var turnsarray = [];
    var mode = 0;
    var turns = 0;
    var startid = {};
    var endid = {};

    function generateLeminColor(seed) {
        return (
            "#"+ Math.floor((Math.abs(Math.sin(seed) * 16777215)) % 16777215).toString(16)
        );
    }

    function parse_room_init(line, special) {
        var room = line.split(" ");
        var size = 3;
        var color = '#f00';

        if (special == "start") {
            size = lemins;
            startid = room[0];
        }
        if (special == "start" || special == "end") {
            color = '#0f0';
        }
        if (special == "end")
            endid = room[0];
        s.graph.addNode({
            id: room[0],
            label: room[0],
            x: room[1],
            y: room[2],
            size: size,
            color: color
        });
        graphcopy.addNode(
            {
                id: room[0],
                label: room[0],
                x: room[1],
                y: room[2],
                size: size,
                color: color
            }
        )
    }

    function parse_link(line) {
        var link = line.split("-");
        console.log("Add link: " + line);
        s.graph.addEdge({
            id: line,
            source: link[0],
            target: link[1],
            color: '#80f',
            type: 'curve',
            size: 0.1
        });
        graphcopy.addEdge(
            {
                id: line,
                source: link[0],
                target: link[1],
                color: '#80f',
                type: 'curve',
                size: 0.1
            }
        )
    }

    function applyTurnToGraph(line) {
        var leminsPosition = line.split(" ");

        leminsPosition.forEach(function(element, index, array) {
            var linfo = element.split("-");

            if (linfo[1] == endid) {
                s.graph.nodes(endid).size += 1;
            }
            else {
                s.graph.nodes(linfo[1]).label += " " + linfo[0];
                s.graph.nodes(linfo[1]).color =
                    generateLeminColor(linfo[0].substr(1));
            }
        });
    }

    function showTurn(element) {
        applyTurnToGraph(turnsarray[element.value]);
        s.refresh();
        console.log(graphcopy.nodes());
        console.log(s.graph.nodes());
        s.graph.clear();
        s.graph.read({nodes: graphcopy.nodes(), edges: graphcopy.edges()});
        console.log(s.graph.nodes());
    }

    function initGraph() {
        text.forEach(function (line, index, array) {
            if (line[0] == 'L'){
                $('#turnsbuttonbar').append(
                    "<li class='turnsbutton' type='button' value='" +
                    turnsarray.length +
                    "' onclick='showTurn(this)'>" + turnsarray.length + "</li>"
                );
                turnsarray.push(line);
            }
            else if  (mode == 3) {
                mode = 0;
            }
            else if (line == "##start") {
                parse_room_init(array[index + 1], "start");
                mode = 3;
            }
            else if (line == "##end") {
                parse_room_init(array[index + 1], "end");
                mode = 3;
            }
            else if (line[0] == '#') {

            }
            else if (mode == 0 && line.indexOf("-") > -1)
                mode = 1;
            else if (mode == 0)
                parse_room_init(line, "none");
            else if (mode == 1 && line.indexOf("-") > -1)
                parse_link(line);
        });
    }
    initGraph();
    ;  console.log(graphcopy)
    s.refresh();
</script>
</body>
</html>